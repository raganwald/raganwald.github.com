---
title: An ES6 function to compute the nth Fibonacci number
layout: default
tags: [allonge]
---

![Fibonacci Spiral](/assets/images/fibonacci.png)

Once upon a time, programming interviews would include a [fizz-buzz](http://raganwald.com/2007/01/dont-overthink-fizzbuzz.html "Don't Overthink FizzBuzz") problem to weed out the folks who couldn't string together a few lines of code. We can debate when and how such things are appropriate interview questions, but one thing that is always appropriate is to use them as inspiration for practising our own skills.[^candid]

[^candid]: Actually, let me be candid: I just like programming, and I find it's fun, even if I don't magically transform myself into a 10x programming ninja through putting in 10,000 hours of practice. But practice certainly doesn't hurt.

There are various common problems offered in such a vein, including fizz-buzz itself, computing certain prime numbers, and computing Fibonacci number. [A few years back][2008], I had a go at writing my own Fibonacci function. When I started researching approaches, I discovered an intriguing bit of matrix math, so I learned something while practicing my skills.[^closed]

[2008]: http://raganwald.com/2008/12/12/fibonacci.html

[^closed]: There is a [closed-form solution](http://en.wikipedia.org/wiki/Fibonacci_number#Closed-form_expression) to the function `fib`, but floating point math has some limitations you should be aware of before [using it in an interview](http://raganwald.com/2013/03/26/the-interview.html). Naturally, if you're running into some of those limits, you would use a BigInt library such as [BigInteger.js](https://github.com/peterolson/BigInteger.js).

### enter the matrix

One problem with calculating a Fibonacci number is that naïve algorithms require _n_ additions. This is obviously expensive for large values of _n_. But of course, there are some interesting things we can do to improve on this.

In this solution, we observe that we can express the Fibonacci number `F(n)` using a 2x2 matrix that is raised to the power of _n_:

    [ 1 1 ] n      [ F(n+1) F(n)   ]
    [ 1 0 ]    =   [ F(n)   F(n-1) ]


On the face of it, raising someting to the power of _n_ turns _n_ additions into _n_ multiplications. _n_ multiplications sounds worse than _n_ additions, however there is a trick about raising something to a power that we can exploit. Let's start by writing some code to multiply matrices:

[Multiplying two matrices](http://www.maths.surrey.ac.uk/explore/emmaspages/option1.html "Matrices and Determinants") is a little interesting if you have never seen it before:

    [ a b ]       [ e f ]   [ ae + bg  af + bh ]
    [ c d ] times [ g h ] = [ ce + dg  cf + dh ]

Our matrices always have diagonal symmetry, so we can simplify the calculation because _c_ is always equal to _b_:

    [ a b ]       [ d e ]   [ ad + be  ae + bf ]
    [ b c ] times [ e f ] = [ bd + ce  be + cf ]

Now we are given that we are multiplying two matrices with diagonal symmetry. Will the result have diagonal symmetry? In other words, will `ae + bf` always be equal to `bd + ce`? Remember that `a = b + c` at all times and `d = e + f` provided that each is a power of `[[1,1], [1,0]]`. Therefore:

    ae + bf = (b + c)e + bf
            = be + ce + bf
    bd + ce = b(e + f) + ce
            = be + bf + ce

That simplifies things for us, we can say:

    [ a b ]       [ d e ]   [ ad + be  ae + bf ]
    [ b c ] times [ e f ] = [ ae + bf  be + cf ]

And thus, we can always work with three elements instead of four. Let's express this as operations on arrays:

    [a, b, c] times [d, e, f] = [ad + be, ae + bf, be + cf]

Which we can code in JavaScript:

{% highlight javascript %}
let times = (...matrices) =>
  matrices.reduce(
    ([a,b,c], [d,e,f]) => [a*d + b*e, a*e + b*f, b*e + c*f]
  );

times([1, 1, 0]) // => [1, 1, 0]
times([1, 1, 0], [1, 1, 0]) // => [2, 1, 1]
times([1, 1, 0], [1, 1, 0], [1, 1, 0]) // => [3, 2, 1]
times([1, 1, 0], [1, 1, 0], [1, 1, 0], [1, 1, 0]) // => [5, 3, 2]
times([1, 1, 0], [1, 1, 0], [1, 1, 0], [1, 1, 0], [1, 1, 0]) // => [8, 5, 3]
{% endhighlight %}

To get exponentiation from multiplication, we could write out a naive implementation that constructs a long array of copies of `[1, 1, 0]` and then calls `times`:

{% highlight javascript %}
let naive_power = (matrix, n) =>
  times(...new Array(n).fill([1, 1, 0]));

naive_power([1, 1, 0], 1) // => [1, 1, 0]
naive_power([1, 1, 0], 2) // => [2, 1, 1]
naive_power([1, 1, 0], 3) // => [3, 2, 1]
naive_power([1, 1, 0], 4) // => [5, 3, 2]
naive_power([1, 1, 0], 5) // => [8, 5, 3]
{%endhighlight %}

Very interesting, and less expensive than multiplying any two arbitrary matrices, but we are still performing _n_ multiplications when we raise a matrix to the _nth_ power. What can we do about that?

### exponentiation with matrices

Now let's make an observation: instead of accumulating a product by iterating over the list, let's [Divide and Conquer](http://www.cs.berkeley.edu/~vazirani/algorithms/chap2.pdf). Let's take the easy case: Don't you agree that `times([1, 1, 0], [1, 1, 0], [1, 1, 0], [1, 1, 0])` is equal to `times(times([1, 1, 0], [1, 1, 0]), times([1, 1, 0], [1, 1, 0]))`? And that this saves us an operation, since `times([1, 1, 0], [1, 1, 0], [1, 1, 0], [1, 1, 0])` is implemented as:

{% highlight javascript %}
times([1, 1, 0],
  times([1, 1, 0],
    times([1, 1, 0], [1, 1, 0]))
{%endhighlight %}

Whereas `times(times([1, 1, 0], [1, 1, 0]), times([1, 1, 0], [1, 1, 0]))` can be implemented as:

{% highlight javascript %}
let double = times([1, 1, 0], [1, 1, 0]),
    quadruple = times(double, double);
{%endhighlight %}

This only requires two operations rather than three. Furthermore, it is recursive. `naive_power([1, 1, 0], 8)` requires seven operations. However, it can be formulated as:

{% highlight javascript %}
let double = times([1, 1, 0], [1, 1, 0]),
    quadruple = times(double, double),
    octuple = times(quadruple, quadruple);
{%endhighlight %}

Now we only need three operations compared to seven. Of course, we left out how to deal with odd numbers. Fixing that also fixes how to deal with even numbers that aren't neat powers of two:

{% highlight javascript %}
let power = (matrix, n) => {
  if (n === 1) return matrix;

  let halves = power(matrix, Math.floor(n / 2));

  return n % 2 === 0
         ? times(halves, halves)
         : times(halves, halves, matrix);
}

power([1, 1, 0], 1) // => [1, 1, 0]
power([1, 1, 0], 2) // => [2, 1, 1]
power([1, 1, 0], 3) // => [3, 2, 1]
power([1, 1, 0], 4) // => [5, 3, 2]
power([1, 1, 0], 5) // => [8, 5, 3]
{%endhighlight %}

Now we can perform exponentiation of our matrices, and we take advantage of the symmetry to perform _log2n_ multiplications.

### and thus to fibonacci

Thusly, we can write our complete fibonacci function:

{% highlight javascript %}
let matrixFibonacci = (n) =>
  n < 2
  ? n
  : power([1, 1, 0], n - 1)[0]

new Array(20).fill().map((_, i) => matrixFibonacci(i))
  // => [0,1,1,2,3,5,8,13,21,34,55,89,144,233,377,610,987,1597,2584,4181]
{%endhighlight %}

If we'd like to work with very large numbers, JavaScript's integers are insufficient. Borrowing a BigInt library like [BigInteger.js](https://github.com/peterolson/BigInteger.js), our solution becomes:

{% highlight javascript %}
var bigInt = require("big-integer");

let times = (...matrices) =>
  matrices.reduce(
    ([a, b, c], [d, e, f]) => [
        a.times(d).plus(b.times(e)),
        a.times(e).plus(b.times(f)),
        b.times(e).plus(c.times(f))
      ]
  );

let power = (matrix, n) => {
  if (n === 1) return matrix;

  let halves = power(matrix, Math.floor(n / 2));

  return n % 2 === 0
         ? times(halves, halves)
         : times(halves, halves, matrix);
}

let matrixFibonacci = (n) =>
  n < 2
  ? n
  : power([bigInt.one, bigInt.one, bigInt.zero], n - 1)[0]

matrixFibonacci(1000000).toString()
  // =>
    1953282128707757731632014947596256332443542996591
    8733969534051945716252578870156947666419876341501
    4612887952433522023608462551091201956023374401543
    8115196636156919962125642894303370113827800638002
    7674115279274666698655783793188228320612714975832
    3033485489348957259923072291290192820926433162752
    1730861460017912582042699659936020959339202005184
    8620284024473431398113674187202038684801753185386
    2111287810824061774138329355456168760645406512595
    4718029126547942894036981659206361019359291352135
    4103767990829403201557027161153950319759732477821
    6295763162965335669477766328506234524559346064757
    5025935813443457816767646258788590113727299073729
    4785114480895724561915035070255895291168685500088
    0201323345874721779478144754679201609017064258562
    9359747546532757575740077432034913428785189795354
    3047345603077650789387672865391667992328174493619
    9152376814955763208537104785970618843873153058239
    5627560879063107819004975169594709736713891745704
    5552021351233507944033607120305041446852210415650
    3732106793227562586475119146114173603496812173802
    3422478608029202109319249649040983239706683247054
    4417635125267324552754195016838452060230073949598
    5427929829783120438211575764578769249558335140252
    2152720662441809003259380753628491796680952971185
    0719137983367887377045991363933395581421203699026
    1617972113250918400230553276071043164781909743004
    3464779336328760146999612802392582947155731668894
    3339455429292871877487747892042961663565366107960
    2391970210972847296670942733458634479804863394463
    5211654971507261342768205479320931750798880101304
    1602798250635418234403455874223670128266635693461
    1294613123128389060036547327660245693151518500183
    2848315064548002997893598516123707404615822935444
    0701748339514575869547491750264542126364262224720
    6004885546258996119047589210122428054289862159464
    6662478564373572217775549876087685912030118551635
    6689020103446399839773266388890365078416180709154
    5252992759735213957415477729146008794314339156060
    4458251078235116627189263792331301464388059787946
    8444879060576786297460989627426663569682474293386
    7402074365594260579447907119305225893159071938654
    5525880429139747140181849169733838138446154843063
    1236492908355842780784561319364575591172213694633
    8180311600307896211668652895953778436464402382516
    3624497181973854441495631317140028503389282227413
    4603018094224837216321854717270452813824078425638
    7473652491411180807838665063399453762392067005133
    9187333107136069698189628284763245423299306272870
    4579912932457411675339022744999630965666809222625
    1646858254455785134982414412726124015815753818098
    4666671450069888391785518008943701890257219924852
    0874291556026191775228124660628996787166529678487
    2684849050413284972977126880116399783764342802024
    5225155010224035416988518537501584673881194047619
    7206196031265344967599178932444781707029044465895
    7195022880915779389764242375181402099899958161231
    4779022957811001686701867386198617971381398546662
    8196954855374070735622861616553942807641840809212
    0479328166830059845047879294063563180974797551520
    3509468276591874161090763750690276529436756153980
    3261388901944859410045292275418809457356207954218
    9966296344134639695598099137501005376025944011361
    7219176881147264713549808756023398475901193275473
    8925753084798049073358372367268170337326650466293
    5776546556869564461372372060072729703747567517816
    0438011413184468787091159497993877778112826432679
    8279051570834173895471133031409372436803880906566
    5957667870755140187437197688278743714687308503592
    7166554972119678413041265038397356729644107267553
    4867583350405142738245998707414685317897838502526
    4966563254268335071699401991896761177847650287886
    7933450663917042267377324685763362119097117544591
    6219735440612809994162559376843478887835657527774
    0197279185139938306590001830403337013193689459672
    2887286073304345913658301133823320413075361823445
    0087661457072523768694579629736468411076297289773
    2027850828281955075446308468484756143811757369501
    4515061356879019554017004594786112602714165855107
    1088345832529082512441105583375897863704748059860
    4534725150025762095910841373021132740844620226836
    6321335377576637894631388327469117232059029540024
    9563180463962904282511861823069631606413805768566
    6698871758257331837726268667003522646754534510986
    7017615892072456468146637904048253978140892591317
    5892496646873486705631883193817545825928711969042
    2960205931222613128323083973803206974757823269260
    5308980311770033917562283307963602287807482899093
    6449684079165607521124185121357011494106314604057
    3880416947567100223164609005371147021078438243901
    1983517900139825749029644505028152512725089213024
    0862522693038168620273414718216156545123737064349
    1134308838898502296381731757531465041063838617337
    2984318819533933533642298635991688903620411786854
    3826798712986683052621123913878725711808354320132
    0812834628604561889008996018576810677640600412068
    9222873305000726870381201762912262517414860220909
    1587019278541185007110110948073032156270509275156
    3839497648261175797191620600935159544121293891224
    2384383652138590707693874781859864896141013246370
    0675457719970781802401938051763343680816656390378
    3010055736065064024115837030833675216025480329208
    5612867732313373362379424922294864676925567558251
    0082542731697796399173023320969866535911843612180
    9929841654616212314560447047098519704889821957541
    2240848443043149194702091429384884700501409135147
    7163750465039879365139122322975356679688686607309
    9364487100118270243467015152939144433130825250271
    3127396984416680670317092936754370540350299990607
    4781067717930123916380180347981940855924023118494
    8812768037140516243341192617814197960302118689551
    2327740124378547066213324583016607503798862163692
    6561326802921156544795730058589912408903987073678
    6816024743369015482785086886940005722068261645002
    1098959890770030609041005062058815019699745916836
    2808231108618529429700616082103280758914076323989
    7603704908975836462161179429558685567896550604050
    3320129464965916297209893507248742658354718355489
    3834362382683027261391459804683447820578745317784
    8330029376183090289206273358192763633530009609443
    3420601331879098335472391194147544124773291564614
    8560842439512600507960500976384006973642399124879
    2249855016507369705966996207374691627230114078525
    1213413640426436120545921748182265977547588787157
    6449973889045227199530567088413439341640459264765
    4713774104673257585115553516070479895704700510319
    4770481118528369985948356317514237815195793935902
    1464769229769305342995712046209948535535809178192
    3198462685976392666423481341924430882523363452151
    9689643325451204143353164193407923285623499294739
    8757207370582426056935826222604770315685258560219
    8814270812477986750894103054803377873812225707904
    2153155708562448355644289391526762729234390208715
    0071599564528146503541159447689796260910868490306
    0468670474153595917535264499505923919715006573151
    5213694220428340424197603380521272939051334630743
    0964069204937782597954222292822046953267373341633
    6668588846457079966395842550207610239331119814055
    7172683334954852962678694901760541301175084700900
    9750867278596843438297631820231924418799454522134
    0098622001041369702143463342830017374802666053616
    2405420766907387041723004780874591443000841637439
    7456627900795807599264543387138394543634400834346
    4826417207435266042284109856361810202326776514839
    4789420336596136927452074205760207344974764497601
    7294371967560216536789473872182777221675063261133
    6048791929635750907896839050962568330292288400563
    1642169135352972646413604206390452757832741107195
    9813216206422039588226486951763832235329234801161
    0881311261106271267685035087283854764026660934432
    9693480998967166783675952437452144198444817581720
    2349208255067791489207515836875157192596112437298
    3147056498362310248522878192869959675946998201291
    8581221889338414080525465572215516207420065649486
    6170768106340328552080962736995604867477416863836
    1605526518402819142666332070177844102323664492602
    0816372328993276884908689708745590124705036671019
    1801625285813312865597398408146967225578322237221
    0083698237248108017015025524146591238887827192710
    1524149423814209733618378016061552707989975524225
    3877823574838633722389675126100481979503656390001
    9669212252988250537074635777214099633452493069027
    9714263735572978669610318192406492901487985982369
    8251210941243604977424081311919747146820089972044
    7846623544830980729197271342483597420001412107905
    1227260754579356974711936974002570263964485288664
    6897668469047722085373795350484170327735814242215
    6080249515920253281174836812910057716728718234042
    0093227989220315429335466576398667888423664025346
    0478081377253289679941566089126066160665059676769
    6898094228614147199514608530123351970176085717456
    0302179393547749667790943145537582633324079471297
    8963726284696856867812785367444458582928650492831
    3033282738695974842963988872916980106355359483841
    8070952685427728295165292536436648908500618932909
    0227070932007672797131397118516172543653291844538
    5942930129507576782651703313810138644618989502637
    9294335066910534338127550518447184827233921808819
    4479150576898067455513181781442747309525171675712
    2348733123981261923485452421175130831592008270062
    2157663791342436156534323493361745812383407932042
    4775237839421253474372583854417860026599779016390
    4465551423648098535367778567581087741024781011311
    5884575316520705828484062218494024990149498817474
    8347156008793203007912646199474538401598458386480
    7555639796756649656985656883484282916124951854928
    3584492818732751493831823497237572544557281405380
    3690612314056825542803287546432402794146612889642
    3954071325945400160339220487826742793145087481471
    8846465531744524045529373059487876236297730199722
    5319760734656087036477702239506823719190951722610
    7562305752012603143768219262427437567576489154066
    2426766549611865368305788363712155244270811247389
    3497797581500868741858398234646901949154504838739
    5796376989584574782092242025056509233460973369552
    8058863666543212607314699731589623383441713671422
    6478797575974778337571284915933140599829590553605
    4277949074247958075978257089428571620019758299462
    7380409303181120758171232576286855265067441056717
    2505451587691855805247572354750160688939324356696
    7653898112717447391523024096274259929447541476357
    9332027576781734302384303908154711419918307768598
    7075408373214161470787997803785156176137540031377
    9062304252968959170824018195159777291115816007837
    9969257136851268750075969005202305674157129447149
    9992013799301505123176186874347152234084046070295
    5329500584912049113955484722424461780387199881410
    9852189941487259979035005338078157515671262524359
    1087138504440728672767146113565284580638373320683
    1712488009147985560630008148819516938944127671765
    4489308629084778729732003990440142604803243310583
    1426065071002940908396423007919460944688356737769
    5933616232409573174126817995262365856367525061023
    6448552755149072891909818173687508562154371395856
    9462579635511373166144733581050372423790956012730
    8889881262410923458672317761875689645595594936934
    1917437721698547501337810293698734311311165017417
    3980163298364750521273498779032395177050489157397
    3722005830749597929361128419730727926085586966966
    3191165278423737168011604134161027542103004841269
    5019435298417903190172318972642428637967169909030
    6355325729516967769637740509409865358666632605798
    3537966017763805021837990841809540435425932825686
    9543425889636385249319903620082186533902716881472
    3788585399015622749973670504932172221980637341719
    3691904189900579513805716744086941934541408070120
    4726094480024222755388369585720281827299346832771
    7423792604968990038811919000949869971743941485886
    2826224865385048000427589657155738860078795807531
    4102690314856808827632084237054213435479886958257
    3823724592965804751092643585677933098615694198673
    0235566624797311190416068116991363756654352688341
    5978967585613712360992907999179828778435773257067
    9093872739254446037552902149288917194599697371629
    3239640822490438619222328217815283469478911973221
    7147927054725793051687779405765180398818543858058
    8592175033810465225870607363739335921775608849152
    6062211897308888815506835088989709660563296359233
    6253119105083145031641783341540370370912793766996
    3531240260433656528220022614194676132233332046618
    3050481655699468877732266368225763195847045636979
    2465220016948829658555113628515643765153564982272
    4375055169981929729898911585510590471476163226624
    8246118951693489867397940759691697962495482380638
    7790338002833725053288993800516909782342331262412
    4993358223456404683495506613689874128276800297834
    0582525683596774392874833583069172870399856263546
    3340828100689084703976206414821817408736947199105
    8747197389181443017795907433382960905464231098715
    1862378512918036996654716806198235572873204944053
    5967290510852088346639929977857619421482101950335
    4044142419396757680456524697074665437927024642924
    81809810384952601580425138896021
{%endhighlight %}

We're done. And this is a win over the typical recursive or even iterative solution for large numbers, because while each operation is more expensive, we only perform _log2n_ operations.[^notfastest]

[^notfastest]: No, this isn't [the fastest implementation](http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/194815 "Fast Fibonacci method") by far. But it beats the pants off of a naïve iterative implementation.

(This is a translation of a blog post written in [2008])

---

notes:
